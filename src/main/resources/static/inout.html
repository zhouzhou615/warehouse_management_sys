<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>出入库管理</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/element-plus/2.4.4/index.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.9/vue.global.prod.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/element-plus/2.4.4/index.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        .inout-tabs {
            background: white;
            border-radius: 8px;
            padding: 20px;
        }
        .type-in { color: #67c23a; }
        .type-out { color: #f56c6c; }
        .anomaly-high {
            background: #fef0f0;
            color: #f56c6c;
            border-left: 3px solid #f56c6c;
        }
        .anomaly-medium {
            background: #fdf6ec;
            color: #e6a23c;
            border-left: 3px solid #e6a23c;
        }
        .cluster-badge-0 { background: #5470c6; color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px; }
        .cluster-badge-1 { background: #91cc75; color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px; }
        .cluster-badge-2 { background: #fac858; color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px; }
        .operator-display {
            background-color: #f5f7fa;
            padding: 10px 15px;
            border-radius: 4px;
            border: 1px solid #dcdfe6;
            color: #606266;
            font-weight: 500;
        }
    </style>
</head>
<body>
<div id="app">
    <el-card class="inout-tabs">
        <el-tabs v-model="activeTab">
            <!-- 出入库操作 -->
            <el-tab-pane label="出入库操作" name="operate">
                <el-row :gutter="20">
                    <el-col :span="10">
                        <el-card header="出入库单据">
                            <!-- 当前操作员信息 -->
                            <div style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 4px; border-left: 4px solid #409eff;">
                                <div style="display: flex; align-items: center;">
                                    <i class="el-icon-user" style="font-size: 18px; color: #409eff; margin-right: 10px;"></i>
                                    <div>
                                        <div style="font-weight: bold; color: #409eff;">当前操作员</div>
                                        <div style="margin-top: 5px;">
                                            <span style="font-weight: 500;">{{ currentUser.operatorName }}</span>
                                            <span style="margin-left: 10px; color: #909399;">(ID: {{ currentUser.operatorId }})</span>
                                            <span style="margin-left: 10px; color: #67c23a; font-size: 12px;">
                                                {{ currentUser.department || '未设置部门' }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <el-form :model="inoutForm" :rules="inoutRules" ref="inoutFormRef" label-width="100px">
                                <el-form-item label="操作类型" prop="inoutType">
                                    <el-radio-group v-model="inoutForm.inoutType">
                                        <el-radio label="入库">
                                            <span class="type-in">入库</span>
                                        </el-radio>
                                        <el-radio label="出库">
                                            <span class="type-out">出库</span>
                                        </el-radio>
                                    </el-radio-group>
                                </el-form-item>

                                <el-form-item label="物料" prop="materialId">
                                    <el-select
                                            v-model="inoutForm.materialId"
                                            filterable
                                            placeholder="请选择物料"
                                            style="width: 100%"
                                            @change="handleMaterialChange">
                                        <el-option
                                                v-for="m in materials"
                                                :key="m.materialId"
                                                :label="`${m.materialId} - ${m.materialName}`"
                                                :value="m.materialId">
                                        </el-option>
                                    </el-select>
                                </el-form-item>

                                <el-form-item label="当前库存">
                                    <el-input v-model="currentStock" disabled></el-input>
                                </el-form-item>

                                <el-form-item label="数量" prop="quantity">
                                    <el-input-number
                                            v-model="inoutForm.quantity"
                                            :min="0.01"
                                            :precision="2"
                                            style="width: 100%">
                                    </el-input-number>
                                </el-form-item>

                                <el-form-item label="操作员">
                                    <div class="operator-display">
                                        <div style="display: flex; align-items: center;">
                                            <i class="el-icon-user-solid" style="margin-right: 8px; color: #409eff;"></i>
                                            <span>{{ currentUser.operatorName }} ({{ currentUser.operatorId }})</span>
                                            <el-tag size="small" style="margin-left: 8px;" type="info">
                                                {{ currentUser.department || '未设置部门' }}
                                            </el-tag>
                                        </div>
                                    </div>
<!--                                    <div style="font-size: 12px; color: #909399; margin-top: 5px;">-->
<!--                                        操作员固定为当前登录用户，不可更改-->
<!--                                    </div>-->
                                </el-form-item>

                                <el-form-item label="备注">
                                    <el-input
                                            v-model="inoutForm.remark"
                                            type="textarea"
                                            :rows="3"
                                            placeholder="请输入备注信息（可选）">
                                    </el-input>
                                </el-form-item>

                                <el-form-item>
                                    <el-button
                                            type="primary"
                                            @click="submitInout"
                                            :loading="submitting">
                                        提交{{ inoutForm.inoutType }}单据
                                    </el-button>
                                    <el-button @click="resetInoutForm">重置</el-button>
                                    <el-button type="info" @click="checkAnomaly" :loading="checkingAnomaly">
                                        AI异常检测
                                    </el-button>
                                </el-form-item>
                            </el-form>

                            <!-- 异常检测结果 -->
                            <div v-if="anomalyCheckResult" style="margin-top: 20px; padding: 15px; border-radius: 4px;"
                                 :class="anomalyCheckResult.isAnomaly ? (anomalyCheckResult.zScore >= 3 ? 'anomaly-high' : 'anomaly-medium') : ''">
                                <h4 style="margin-top: 0;">
                                    <i class="el-icon-cpu" style="margin-right: 8px;"></i>
                                    AI异常检测结果
                                </h4>
                                <div v-if="anomalyCheckResult.isAnomaly">
                                    <p><strong>⚠️ 检测到异常:</strong> {{ anomalyCheckResult.reason }}</p>
                                    <p><strong>Z分数:</strong> {{ anomalyCheckResult.zScore.toFixed(2) }}</p>
                                    <p><strong>聚类分组:</strong>
                                        <span :class="'cluster-badge-' + (anomalyCheckResult.cluster % 3)">
                                            组{{ anomalyCheckResult.cluster }}
                                        </span>
                                    </p>
                                    <el-alert type="warning" :closable="false" style="margin-top: 10px;">
                                        建议确认此出库操作是否正常
                                    </el-alert>
                                </div>
                                <div v-else>
                                    <p><strong>✅ 检测正常:</strong> 该出库操作在正常范围内</p>
                                    <p><strong>Z分数:</strong> {{ anomalyCheckResult.zScore ? anomalyCheckResult.zScore.toFixed(2) : 'N/A' }}</p>
                                </div>
                            </div>
                        </el-card>
                    </el-col>

                    <el-col :span="14">
                        <el-card header="最近操作记录">
                            <div style="margin-bottom: 15px;">
                                <el-button-group>
                                    <el-button @click="loadRecentRecords">全部记录</el-button>
                                    <el-button type="warning" @click="loadAnomalyRecords">仅异常记录</el-button>
                                    <el-button type="info" @click="loadAIPredictions">AI预测分析</el-button>
                                </el-button-group>
                                <div style="float: right; color: #909399; font-size: 14px;">
                                    当前用户：{{ currentUser.operatorName }}
                                </div>
                            </div>

                            <el-table :data="recentRecords" stripe max-height="500">
                                <el-table-column prop="recordId" label="单据号" width="180"></el-table-column>
                                <el-table-column label="类型" width="80" align="center">
                                    <template #default="scope">
                                            <span :class="scope.row.inoutType === '入库' ? 'type-in' : 'type-out'">
                                                {{ scope.row.inoutType }}
                                            </span>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="materialName" label="物料名称" width="120"></el-table-column>
                                <el-table-column prop="quantity" label="数量" width="80" align="right"></el-table-column>
                                <el-table-column label="操作员" width="120">
                                    <template #default="scope">
                                        <div style="display: flex; align-items: center;">
                                            <i class="el-icon-user" style="margin-right: 5px; color: #909399;"></i>
                                            {{ scope.row.operatorName }}
                                        </div>
                                    </template>
                                </el-table-column>
                                <el-table-column label="异常检测" width="100" align="center">
                                    <template #default="scope">
                                        <div v-if="scope.row.inoutType === '出库' && scope.row.hasAnomaly">
                                            <el-tag
                                                    :type="scope.row.zScore >= 3 ? 'danger' : 'warning'"
                                                    size="small"
                                                    effect="dark">
                                                {{ scope.row.riskLevel }}
                                            </el-tag>
                                        </div>
                                        <span v-else style="color: #67c23a; font-size: 12px;">正常</span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作时间" width="160">
                                    <template #default="scope">
                                        {{ formatDateTime(scope.row.operationTime) }}
                                    </template>
                                </el-table-column>
                            </el-table>
                        </el-card>
                    </el-col>
                </el-row>
            </el-tab-pane>

            <!-- 物料追溯 -->
            <el-tab-pane label="物料追溯" name="trace">
                <div style="margin-bottom: 15px; padding: 10px; background: #f0f9ff; border-radius: 4px;">
                    <i class="el-icon-user" style="margin-right: 8px; color: #409eff;"></i>
                    <span>当前操作员：</span>
                    <strong>{{ currentUser.operatorName }}</strong>
                    <span style="margin-left: 10px; color: #909399;">(ID: {{ currentUser.operatorId }})</span>
                </div>

                <el-form inline>
                    <el-form-item label="物料">
                        <el-select
                                v-model="traceForm.materialId"
                                filterable
                                placeholder="请选择物料"
                                style="width: 250px">
                            <el-option
                                    v-for="m in materials"
                                    :key="m.materialId"
                                    :label="`${m.materialId} - ${m.materialName}`"
                                    :value="m.materialId">
                            </el-option>
                        </el-select>
                    </el-form-item>

                    <el-form-item label="时间范围">
                        <el-date-picker
                                v-model="traceForm.dateRange"
                                type="datetimerange"
                                range-separator="至"
                                start-placeholder="开始时间"
                                end-placeholder="结束时间"
                                format="YYYY-MM-DD HH:mm:ss"
                                value-format="YYYY-MM-DD HH:mm:ss">
                        </el-date-picker>
                    </el-form-item>

                    <el-form-item>
                        <el-button type="primary" @click="traceMaterial">查询</el-button>
                        <el-button @click="resetTraceForm">重置</el-button>
                    </el-form-item>
                </el-form>

                <el-table :data="traceRecords" stripe border>
                    <el-table-column type="index" label="序号" width="60"></el-table-column>
                    <el-table-column prop="recordId" label="单据号" width="180"></el-table-column>
                    <el-table-column label="类型" width="80" align="center">
                        <template #default="scope">
                            <el-tag :type="scope.row.inoutType === '入库' ? 'success' : 'danger'">
                                {{ scope.row.inoutType }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="quantity" label="数量" width="100" align="right"></el-table-column>
                    <el-table-column prop="beforeStock" label="操作前库存" width="120" align="right"></el-table-column>
                    <el-table-column prop="afterStock" label="操作后库存" width="120" align="right"></el-table-column>
                    <el-table-column label="操作员" width="120">
                        <template #default="scope">
                            <div style="display: flex; align-items: center;">
                                <i class="el-icon-user" style="margin-right: 5px; color: #909399;"></i>
                                {{ scope.row.operatorName }}
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column label="操作时间" width="160">
                        <template #default="scope">
                            {{ formatDateTime(scope.row.operationTime) }}
                        </template>
                    </el-table-column>
                    <el-table-column prop="remark" label="备注" min-width="150"></el-table-column>
                </el-table>
            </el-tab-pane>

<!--            &lt;!&ndash; AI分析报告 &ndash;&gt;-->
<!--            <el-tab-pane label="AI分析报告" name="aireport">-->
<!--                <el-card>-->
<!--                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">-->
<!--                        <div>-->
<!--                            <h3 style="margin: 0;">AI智能分析报告</h3>-->
<!--                            <div style="margin-top: 5px; color: #909399; font-size: 14px;">-->
<!--                                操作员：{{ currentUser.operatorName }} | 部门：{{ currentUser.department || '未设置' }}-->
<!--                            </div>-->
<!--                        </div>-->
<!--                        <div>-->
<!--                            <el-button type="primary" @click="generateAIReport">-->
<!--                                <i class="el-icon-refresh"></i> 生成报告-->
<!--                            </el-button>-->
<!--                            <el-button @click="exportAIReport">-->
<!--                                <i class="el-icon-download"></i> 导出报告-->
<!--                            </el-button>-->
<!--                        </div>-->
<!--                    </div>-->

<!--                    <div v-if="aiReport" style="padding: 20px; background: #f9f9ff; border-radius: 8px;">-->
<!--                        <h4 style="color: #667eea; margin-top: 0;">-->
<!--                            <i class="el-icon-document-checked" style="margin-right: 8px;"></i>-->
<!--                            AI分析报告 - {{ aiReport.generateTime }}-->
<!--                        </h4>-->

<!--                        <el-row :gutter="20">-->
<!--                            <el-col :span="8">-->
<!--                                <el-card class="dashboard-card">-->
<!--                                    <div style="text-align: center;">-->
<!--                                        <div style="font-size: 14px; color: #909399;">分析期间</div>-->
<!--                                        <div style="font-size: 18px; color: #667eea; font-weight: bold; margin: 10px 0;">-->
<!--                                            {{ aiReport.analysisPeriod }}-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                </el-card>-->
<!--                            </el-col>-->
<!--                            <el-col :span="8">-->
<!--                                <el-card class="dashboard-card">-->
<!--                                    <div style="text-align: center;">-->
<!--                                        <div style="font-size: 14px; color: #909399;">异常记录</div>-->
<!--                                        <div style="font-size: 18px; color: #f56c6c; font-weight: bold; margin: 10px 0;">-->
<!--                                            {{ aiReport.anomalyCount }} 条-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                </el-card>-->
<!--                            </el-col>-->
<!--                            <el-col :span="8">-->
<!--                                <el-card class="dashboard-card">-->
<!--                                    <div style="text-align: center;">-->
<!--                                        <div style="font-size: 14px; color: #909399;">风险物料</div>-->
<!--                                        <div style="font-size: 18px; color: #e6a23c; font-weight: bold; margin: 10px 0;">-->
<!--                                            {{ aiReport.riskMaterialCount }} 个-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                </el-card>-->
<!--                            </el-col>-->
<!--                        </el-row>-->

<!--                        <div style="margin-top: 20px;">-->
<!--                            <h5>异常记录TOP5</h5>-->
<!--                            <el-table :data="aiReport.topAnomalies" stripe border size="small">-->
<!--                                <el-table-column prop="materialName" label="物料名称"></el-table-column>-->
<!--                                <el-table-column prop="quantity" label="出库数量" align="right"></el-table-column>-->
<!--                                <el-table-column prop="zScore" label="异常程度" align="right">-->
<!--                                    <template #default="scope">-->
<!--                                        <el-tag :type="scope.row.zScore >= 3 ? 'danger' : 'warning'" size="small">-->
<!--                                            {{ scope.row.zScore.toFixed(2) }}-->
<!--                                        </el-tag>-->
<!--                                    </template>-->
<!--                                </el-table-column>-->
<!--                                <el-table-column prop="anomalyReason" label="异常原因"></el-table-column>-->
<!--                            </el-table>-->
<!--                        </div>-->

<!--                        <div style="margin-top: 20px;">-->
<!--                            <h5>AI建议</h5>-->
<!--                            <el-alert-->
<!--                                    v-for="(suggestion, index) in aiReport.suggestions"-->
<!--                                    :key="index"-->
<!--                                    :type="suggestion.type"-->
<!--                                    :closable="false"-->
<!--                                    style="margin-bottom: 10px;">-->
<!--                                {{ suggestion.content }}-->
<!--                            </el-alert>-->
<!--                        </div>-->
<!--                    </div>-->

<!--                    <div v-else style="text-align: center; padding: 40px; color: #909399;">-->
<!--                        <i class="el-icon-document" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>-->
<!--                        <p>点击"生成报告"按钮创建AI分析报告</p>-->
<!--                    </div>-->
<!--                </el-card>-->
<!--            </el-tab-pane>-->
        </el-tabs>
    </el-card>
</div>

<script>
    const { createApp } = Vue;
    const { ElMessage, ElLoading } = ElementPlus;

    axios.defaults.baseURL = '/warehouse';

    // 添加请求拦截器，在请求头中添加token
    axios.interceptors.request.use(
        config => {
            const token = localStorage.getItem('token');
            if (token) {
                config.headers.Authorization = `Bearer ${token}`;
            }
            return config;
        },
        error => {
            return Promise.reject(error);
        }
    );

    // 添加响应拦截器，处理401未授权
    axios.interceptors.response.use(
        response => {
            return response;
        },
        error => {
            if (error.response && error.response.status === 401) {
                ElMessage.error('登录已过期，请重新登录');
                localStorage.removeItem('token');
                localStorage.removeItem('userInfo');
                setTimeout(() => {
                    window.location.href = '../login.html';
                }, 1500);
            }
            return Promise.reject(error);
        }
    );

    createApp({
        data() {
            return {
                activeTab: 'operate',
                materials: [],
                currentStock: '',
                submitting: false,
                checkingAnomaly: false,
                currentUser: {
                    operatorId: '',
                    operatorName: '',
                    department: ''
                },
                inoutForm: {
                    materialId: '',
                    inoutType: '入库',
                    quantity: null,
                    remark: ''
                    // 注意：移除了operatorId字段，将在提交时从currentUser获取
                },
                inoutRules: {
                    materialId: [{ required: true, message: '请选择物料', trigger: 'change' }],
                    inoutType: [{ required: true, message: '请选择操作类型', trigger: 'change' }],
                    quantity: [
                        { required: true, message: '请输入数量', trigger: 'blur' },
                        { type: 'number', min: 0.01, message: '数量必须大于0', trigger: 'blur' }
                    ]
                },
                recentRecords: [],
                anomalyCheckResult: null,
                traceForm: {
                    materialId: '',
                    dateRange: null,
                    showAnomalyOnly: false,
                    showCluster: true
                },
                traceRecords: [],
                materialTrendChart: null,
                aiReport: null
            }
        },
        mounted() {
            this.loadCurrentUser();
            this.loadMaterials();
            this.loadRecentRecords();
        },
        methods: {
            // 加载当前登录用户信息
            loadCurrentUser() {
                try {
                    const userInfo = localStorage.getItem('userInfo');
                    if (!userInfo) {
                        ElMessage.error('请先登录系统');
                        setTimeout(() => {
                            window.location.href = '../login.html';
                        }, 1000);
                        return;
                    }

                    const user = JSON.parse(userInfo);
                    this.currentUser = {
                        operatorId: user.operatorId,
                        operatorName: user.operatorName,
                        department: user.department || ''
                    };

                    console.log('当前登录用户:', this.currentUser);
                } catch (error) {
                    console.error('加载用户信息失败:', error);
                    ElMessage.error('加载用户信息失败');
                }
            },

            // 验证当前用户是否有操作权限
            validateUserPermission() {
                if (!this.currentUser || !this.currentUser.operatorId) {
                    ElMessage.error('用户信息不完整，请重新登录');
                    return false;
                }
                return true;
            },

            async loadMaterials() {
                try {
                    const res = await axios.get('/api/material/list');
                    if (res.data.code === 200) {
                        this.materials = res.data.data;
                    }
                } catch (error) {
                    console.error('加载物料失败:', error);
                }
            },
            async loadRecentRecords() {
                try {
                    const res = await axios.get('/api/inout/recent', {
                        params: { limit: 20 }
                    });
                    if (res.data.code === 200) {
                        this.recentRecords = res.data.data;
                        // 为出库记录添加异常检测标记
                        this.recentRecords.forEach(record => {
                            if (record.inoutType === '出库') {
                                this.checkRecordAnomaly(record);
                            }
                        });
                    }
                } catch (error) {
                    console.error('加载记录失败:', error);
                }
            },
            async loadAnomalyRecords() {
                try {
                    const res = await axios.get('/api/db4ai/anomaly-records', {
                        params: {
                            startDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                            endDate: new Date().toISOString().split('T')[0]
                        }
                    });
                    if (res.data.code === 200) {
                        this.recentRecords = res.data.data.map(record => ({
                            recordId: record.recordId,
                            materialId: record.materialId,
                            materialName: record.materialName,
                            inoutType: '出库',
                            quantity: record.quantity,
                            operatorId: record.operatorId,
                            operatorName: record.operatorName,
                            operationTime: record.operationTime,
                            hasAnomaly: true,
                            anomalyReason: record.anomalyReason,
                            zScore: record.zScore,
                            cluster: record.cluster,
                            riskLevel: record.zScore >= 3 ? '高风险' : '中风险'
                        }));
                        ElMessage.success(`发现 ${this.recentRecords.length} 条异常记录`);
                    }
                } catch (error) {
                    console.error('加载异常记录失败:', error);
                }
            },
            async loadAIPredictions() {
                try {
                    const res = await axios.get('/api/db4ai/purchase-recommendations');
                    if (res.data.code === 200) {
                        // 转换预测数据为记录格式显示
                        this.recentRecords = res.data.data.map(prediction => ({
                            recordId: `PRED-${prediction.materialId}`,
                            materialId: prediction.materialId,
                            materialName: prediction.materialName,
                            inoutType: '预测',
                            quantity: prediction.predictedChange,
                            operatorId: 'AI系统',
                            operatorName: 'AI预测',
                            operationTime: new Date().toISOString(),
                            remark: `预测库存: ${prediction.predictedStock}, 安全库存: ${prediction.safeStockMin}`,
                            hasAnomaly: prediction.predictedStock < prediction.safeStockMin,
                            anomalyReason: prediction.predictedStock < prediction.safeStockMin ? '预测库存低于安全库存' : null,
                            riskLevel: prediction.predictedStock < prediction.safeStockMin ? '需采购' : '充足'
                        }));
                        ElMessage.info(`显示 ${this.recentRecords.length} 条AI预测结果`);
                    }
                } catch (error) {
                    console.error('加载AI预测失败:', error);
                }
            },
            handleMaterialChange(materialId) {
                const material = this.materials.find(m => m.materialId === materialId);
                if (material) {
                    this.currentStock = `${material.currentStock} ${material.unit}`;
                }
            },
            async checkAnomaly() {
                if (this.inoutForm.inoutType !== '出库') {
                    ElMessage.warning('异常检测仅适用于出库操作');
                    return;
                }

                if (!this.inoutForm.materialId || !this.inoutForm.quantity) {
                    ElMessage.warning('请先选择物料和输入数量');
                    return;
                }

                this.checkingAnomaly = true;
                try {
                    console.log('开始异常检测:', {
                        materialId: this.inoutForm.materialId,
                        quantity: this.inoutForm.quantity
                    });

                    // 1. 调用聚类预测接口 - 使用正确的请求格式
                    const clusterRes = await axios.post('/api/db4ai/test-cluster', {
                        quantity: parseFloat(this.inoutForm.quantity)
                    });

                    console.log('聚类预测响应:', clusterRes.data);

                    if (clusterRes.data.code !== 200) {
                        throw new Error(clusterRes.data.message || '聚类预测失败');
                    }

                    // 2. 获取物料统计信息
                    let statsRes;
                    try {
                        statsRes = await axios.get(`/api/db4ai/material-stats/${this.inoutForm.materialId}`);
                        console.log('物料统计响应:', statsRes.data);
                    } catch (statsError) {
                        console.warn('获取物料统计失败，使用默认值:', statsError);
                        statsRes = {
                            data: {
                                code: 200,
                                data: {
                                    avg_quantity: 50.0,
                                    std_quantity: 15.0,
                                    record_count: 25
                                }
                            }
                        };
                    }

                    let stats = { avg_quantity: 0, std_quantity: 1, record_count: 0 };
                    if (statsRes.data.code === 200) {
                        stats = statsRes.data.data;
                    }

                    // 3. 计算Z分数
                    const zScore = stats.std_quantity > 0 ?
                        Math.abs(parseFloat(this.inoutForm.quantity) - parseFloat(stats.avg_quantity)) / parseFloat(stats.std_quantity) : 0;

                    // 4. 设置异常检测结果
                    this.anomalyCheckResult = {
                        isAnomaly: zScore >= 2,
                        reason: zScore >= 3 ? '出库量超出历史均值3倍' :
                            zScore >= 2 ? '出库量超出历史均值2倍' : '正常范围',
                        zScore: zScore,
                        cluster: clusterRes.data.data?.predictedCluster || 0,
                        stats: {
                            avg: stats.avg_quantity,
                            std: stats.std_quantity,
                            count: stats.record_count
                        }
                    };

                    console.log('异常检测结果:', this.anomalyCheckResult);

                    // 5. 显示结果消息
                    if (this.anomalyCheckResult.isAnomaly) {
                        ElMessage.warning({
                            message: `检测到异常: ${this.anomalyCheckResult.reason}`,
                            duration: 5000
                        });
                    } else {
                        ElMessage.success({
                            message: '检测正常，操作在合理范围内',
                            duration: 3000
                        });
                    }

                    // 6. 如果是异常，建议用户确认
                    if (this.anomalyCheckResult.isAnomaly) {
                        this.$confirm(`发现异常操作，建议确认后再提交。<br/>
                        Z分数: ${zScore.toFixed(2)}<br/>
                        聚类分组: 组${this.anomalyCheckResult.cluster}<br/>
                        是否继续提交？`,
                            '异常检测警告', {
                                dangerouslyUseHTMLString: true,
                                confirmButtonText: '继续提交',
                                cancelButtonText: '重新输入',
                                type: 'warning'
                            }).catch(() => {
                            // 用户选择重新输入
                            this.inoutForm.quantity = null;
                        });
                    }

                } catch (error) {
                    console.error('异常检测失败:', error);

                    // 提供模拟数据用于演示
                    const mockZScore = 2.0 + Math.random() * 2.0;
                    const isAnomaly = mockZScore >= 2;

                    this.anomalyCheckResult = {
                        isAnomaly: isAnomaly,
                        reason: mockZScore >= 3 ? '出库量超出历史均值3倍（模拟）' :
                            mockZScore >= 2 ? '出库量超出历史均值2倍（模拟）' : '正常范围（模拟）',
                        zScore: mockZScore,
                        cluster: Math.floor(Math.random() * 3),
                        stats: {
                            avg: 50.0,
                            std: 15.0,
                            count: 25
                        },
                        isMock: true
                    };

                    if (isAnomaly) {
                        ElMessage.warning({
                            message: `演示模式: 检测到模拟异常 - ${this.anomalyCheckResult.reason}`,
                            duration: 5000
                        });
                    } else {
                        ElMessage.info({
                            message: '演示模式: 检测正常（模拟数据）',
                            duration: 3000
                        });
                    }
                } finally {
                    this.checkingAnomaly = false;
                }
            },
            async submitInout() {
                try {
                    // 验证用户权限
                    if (!this.validateUserPermission()) {
                        return;
                    }

                    await this.$refs.inoutFormRef.validate();

                    this.submitting = true;

                    // 构建符合InoutDTO格式的数据，使用当前登录用户作为操作员
                    const dto = {
                        materialId: this.inoutForm.materialId,
                        inoutType: this.inoutForm.inoutType,
                        quantity: parseFloat(this.inoutForm.quantity),
                        operatorId: this.currentUser.operatorId,  // 使用当前登录用户的operatorId
                        remark: this.inoutForm.remark
                    };

                    const res = await axios.post('/api/inout/operate', dto);

                    if (res.data.code === 200) {
                        ElMessage.success({
                            message: `${this.inoutForm.inoutType}操作成功！单据号: ${res.data.data.recordId}`,
                            duration: 3000
                        });

                        // 记录操作日志
                        console.log(`操作员 ${this.currentUser.operatorName} (${this.currentUser.operatorId}) 执行了 ${this.inoutForm.inoutType} 操作，物料: ${this.inoutForm.materialId}，数量: ${this.inoutForm.quantity}`);

                        this.resetInoutForm();
                        this.loadRecentRecords();
                        this.loadMaterials();
                    }
                } catch (error) {
                    if (error.response && error.response.data) {
                        ElMessage.error(error.response.data.message || '操作失败');
                    } else {
                        ElMessage.error('操作失败');
                    }
                } finally {
                    this.submitting = false;
                }
            },
            async traceMaterial() {
                if (!this.traceForm.materialId) {
                    ElMessage.warning('请选择物料');
                    return;
                }

                try {
                    const dto = {
                        materialId: this.traceForm.materialId,
                        startDate: this.traceForm.dateRange ? this.traceForm.dateRange[0] : null,
                        endDate: this.traceForm.dateRange ? this.traceForm.dateRange[1] : null
                    };

                    const res = await axios.post('/api/inout/trace', dto);
                    if (res.data.code === 200) {
                        let records = res.data.data;

                        // 为出库记录添加异常检测
                        records.forEach(record => {
                            if (record.inoutType === '出库') {
                                this.checkRecordAnomaly(record);
                            }
                        });

                        // 过滤仅显示异常记录
                        if (this.traceForm.showAnomalyOnly) {
                            records = records.filter(r => r.hasAnomaly);
                        }

                        this.traceRecords = records;
                        ElMessage.success(`查询到${records.length}条记录`);

                        // 渲染趋势图表
                        this.renderMaterialTrendChart();
                    }
                } catch (error) {
                    if (error.response && error.response.data) {
                        ElMessage.error(error.response.data.message || '查询失败');
                    } else {
                        ElMessage.error('查询失败');
                    }
                }
            },
            async checkRecordAnomaly(record) {
                try {
                    // 获取物料统计信息
                    const statsRes = await axios.get(`/api/db4ai/material-stats/${record.materialId}`);
                    let stats = { avg_quantity: 0, std_quantity: 1, record_count: 0 };
                    if (statsRes.data.code === 200) {
                        stats = statsRes.data.data;
                    }

                    // 计算Z分数
                    const zScore = stats.std_quantity > 0 ?
                        Math.abs(record.quantity - stats.avg_quantity) / stats.std_quantity : 0;

                    // 预测聚类
                    const clusterRes = await axios.post('/api/db4ai/test-cluster', {
                        quantity: record.quantity
                    });
                    const cluster = clusterRes.data.code === 200 ?
                        clusterRes.data.data.predictedCluster : 0;

                    // 添加异常标记
                    record.hasAnomaly = zScore >= 2;
                    record.anomalyReason = zScore >= 3 ? '出库量超出历史均值3倍' :
                        zScore >= 2 ? '出库量超出历史均值2倍' : '正常';
                    record.zScore = zScore;
                    record.cluster = cluster;
                    record.riskLevel = zScore >= 3 ? '高风险' :
                        zScore >= 2 ? '中风险' : '正常';

                } catch (error) {
                    console.error('为记录添加异常检测失败:', error);
                }
            },
            renderMaterialTrendChart() {
                const chartDom = document.getElementById('materialTrendChart');
                if (!chartDom || this.traceRecords.length === 0) return;

                if (this.materialTrendChart) {
                    this.materialTrendChart.dispose();
                }

                this.materialTrendChart = echarts.init(chartDom);

                // 按时间排序
                const sortedRecords = [...this.traceRecords].sort((a, b) =>
                    new Date(a.operationTime) - new Date(b.operationTime)
                );

                const dates = sortedRecords.map(r =>
                    new Date(r.operationTime).toLocaleDateString('zh-CN')
                );

                const stockLevels = sortedRecords.map(r => r.afterStock);
                const inQuantities = sortedRecords
                    .filter(r => r.inoutType === '入库')
                    .map(r => ({ date: new Date(r.operationTime).toLocaleDateString('zh-CN'), value: r.quantity }));

                const outQuantities = sortedRecords
                    .filter(r => r.inoutType === '出库')
                    .map(r => ({
                        date: new Date(r.operationTime).toLocaleDateString('zh-CN'),
                        value: r.quantity,
                        isAnomaly: r.hasAnomaly
                    }));

                const option = {
                    tooltip: {
                        trigger: 'axis',
                        formatter: function(params) {
                            let result = params[0].axisValue + '<br/>';
                            params.forEach(param => {
                                const marker = param.marker;
                                const seriesName = param.seriesName;
                                const value = param.value;
                                const extra = param.dataIndex >= 0 && outQuantities[param.dataIndex]?.isAnomaly ?
                                    '<span style="color:#f56c6c"> (异常)</span>' : '';
                                result += `${marker} ${seriesName}: ${value}${extra}<br/>`;
                            });
                            return result;
                        }
                    },
                    legend: {
                        data: ['库存水平', '入库量', '出库量']
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: dates,
                        axisLabel: {
                            rotate: 45
                        }
                    },
                    yAxis: [
                        {
                            type: 'value',
                            name: '库存水平',
                            position: 'left'
                        },
                        {
                            type: 'value',
                            name: '出入库量',
                            position: 'right'
                        }
                    ],
                    series: [
                        {
                            name: '库存水平',
                            type: 'line',
                            data: stockLevels,
                            yAxisIndex: 0,
                            smooth: true,
                            itemStyle: { color: '#5470c6' },
                            lineStyle: { width: 3 }
                        },
                        {
                            name: '入库量',
                            type: 'bar',
                            data: inQuantities.map(q => q.value),
                            yAxisIndex: 1,
                            itemStyle: { color: '#67c23a' }
                        },
                        {
                            name: '出库量',
                            type: 'bar',
                            data: outQuantities.map(q => q.value),
                            yAxisIndex: 1,
                            itemStyle: function(params) {
                                return {
                                    color: outQuantities[params.dataIndex]?.isAnomaly ? '#f56c6c' : '#e6a23c'
                                };
                            }
                        }
                    ]
                };

                this.materialTrendChart.setOption(option);
            },
//
            resetInoutForm() {
                this.inoutForm = {
                    materialId: '',
                    inoutType: '入库',
                    quantity: null,
                    remark: ''
                };
                this.currentStock = '';
                this.anomalyCheckResult = null;
                this.$refs.inoutFormRef?.resetFields();
            },
            resetTraceForm() {
                this.traceForm = {
                    materialId: '',
                    dateRange: null,
                    showAnomalyOnly: false,
                    showCluster: true
                };
                this.traceRecords = [];
            },
            formatDateTime(dateTime) {
                if (!dateTime) return '';
                return new Date(dateTime).toLocaleString('zh-CN');
            }
        }
    }).use(ElementPlus).mount('#app');
</script>
</body>
</html>