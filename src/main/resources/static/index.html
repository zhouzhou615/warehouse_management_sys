<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工业物料库存管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/element-plus/2.4.4/index.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.9/vue.global.prod.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/element-plus/2.4.4/index.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        #app {
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            padding: 0 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            cursor: pointer;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 30px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .alert-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f56c6c;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div id="app">
    <el-container style="height: 100vh;">
        <!-- 头部导航 -->
        <el-header class="header" height="60px">
            <div style="display: flex; align-items: center; justify-content: space-between; height: 100%;">
                <div class="logo">
                    <i class="el-icon-box"></i>
                    工业物料库存管理系统
                </div>
                <el-menu mode="horizontal" :default-active="activeMenu" @select="handleMenuSelect">
                    <el-menu-item index="dashboard">
                        <i class="el-icon-data-line"></i>
                        <span>数据看板</span>
                    </el-menu-item>
                    <el-menu-item index="material">
                        <i class="el-icon-box"></i>
                        <span>物料管理</span>
                    </el-menu-item>
                    <el-menu-item index="supplier">
                        <i class="el-icon-user"></i>
                        <span>供应商管理</span>
                    </el-menu-item>
                    <el-menu-item index="inout">
                        <i class="el-icon-sort"></i>
                        <span>出入库</span>
                    </el-menu-item>
                    <el-menu-item index="alert">
                        <el-badge :value="alertCount" :hidden="alertCount === 0">
                            <i class="el-icon-warning"></i>
                            <span>库存预警</span>
                        </el-badge>
                    </el-menu-item>
                    <el-menu-item index="statistics">
                        <i class="el-icon-pie-chart"></i>
                        <span>统计分析</span>
                    </el-menu-item>
                </el-menu>
            </div>
        </el-header>

        <!-- 主内容区 -->
        <el-main style="background: transparent;">
            <div class="main-container">
                <!-- 数据看板 -->
                <div v-show="activeMenu === 'dashboard'">
                    <el-row :gutter="20">
                        <el-col :span="6" v-for="stat in dashboardStats" :key="stat.title">
                            <div class="dashboard-card">
                                <div v-if="stat.alert" class="alert-badge">{{ stat.alert }}</div>
                                <div style="margin-bottom: 12px; color: #909399;">{{ stat.title }}</div>
                                <div class="stat-number">{{ stat.value }}</div>
                                <div style="margin-top: 8px; font-size: 14px; color: #67c23a;" v-if="stat.trend">
                                    {{ stat.trend }}
                                </div>
                            </div>
                        </el-col>
                    </el-row>

                    <!-- 图表 -->
                    <div class="chart-container">
                        <h3 style="margin-bottom: 20px;">出入库趋势</h3>
                        <div id="trendChart" style="height: 400px;"></div>
                    </div>

                    <el-row :gutter="20" style="margin-top: 20px;">
                        <el-col :span="12">
                            <div class="chart-container">
                                <h3 style="margin-bottom: 20px;">库存状态分布</h3>
                                <div id="stockStatusChart" style="height: 350px;"></div>
                            </div>
                        </el-col>
                        <el-col :span="12">
                            <div class="chart-container">
                                <h3 style="margin-bottom: 20px;">预警类型分布</h3>
                                <div id="alertTypeChart" style="height: 350px;"></div>
                            </div>
                        </el-col>
                    </el-row>
                </div>

                <!-- 其他页面通过iframe加载 -->
                <iframe
                        v-show="activeMenu === 'material'"
                        src="material.html"
                        frameborder="0"
                        style="width: 100%; height: calc(100vh - 100px); border-radius: 12px; background: white;">
                </iframe>

                <iframe
                        v-show="activeMenu === 'supplier'"
                        src="supplier.html"
                        frameborder="0"
                        style="width: 100%; height: calc(100vh - 100px); border-radius: 12px; background: white;">
                </iframe>

                <iframe
                        v-show="activeMenu === 'inout'"
                        src="inout.html"
                        frameborder="0"
                        style="width: 100%; height: calc(100vh - 100px); border-radius: 12px; background: white;">
                </iframe>

                <iframe
                        v-show="activeMenu === 'alert'"
                        src="alert.html"
                        frameborder="0"
                        style="width: 100%; height: calc(100vh - 100px); border-radius: 12px; background: white;">
                </iframe>

                <iframe
                        v-show="activeMenu === 'statistics'"
                        src="statistics.html"
                        frameborder="0"
                        style="width: 100%; height: calc(100vh - 100px); border-radius: 12px; background: white;">
                </iframe>
            </div>
        </el-main>
    </el-container>
</div>

<script>
    const { createApp } = Vue;
    const { ElMessage } = ElementPlus;

    axios.defaults.baseURL = '/warehouse';

    createApp({
        data() {
            return {
                activeMenu: 'dashboard',
                alertCount: 0,
                dashboardStats: [
                    { title: '物料总数', value: 0, trend: null },
                    { title: '库存总值', value: '¥0', trend: null },
                    { title: '低库存预警', value: 0, alert: 0 },
                    { title: '今日出入库', value: 0, trend: null }
                ],
                trendChart: null,
                stockStatusChart: null,
                alertTypeChart: null
            }
        },
        mounted() {
            this.loadDashboardData();
            this.initCharts();
        },
        methods: {
            handleMenuSelect(index) {
                this.activeMenu = index;
                if (index === 'dashboard') {
                    this.$nextTick(() => {
                        this.initCharts();
                    });
                }
            },
            async loadDashboardData() {
                try {
                    // 1. 获取统计概览数据
                    const overviewRes = await axios.get('/api/statistics/overview');
                    if (overviewRes.data.code === 200) {
                        const data = overviewRes.data.data;
                        this.dashboardStats[0].value = data.total_materials || 0;
                        this.dashboardStats[1].value = '¥' + this.formatNumber(data.total_value);
                        this.dashboardStats[3].value = data.today_inout || 0;

                        // 渲染库存状态分布图
                        this.renderStockStatusChart(data);
                    }

                    // 2. 获取预警统计数据
                    const alertStatsRes = await axios.get('/api/statistics/alertStats');
                    if (alertStatsRes.data.code === 200) {
                        const data = alertStatsRes.data.data;
                        this.alertCount = data.unhandled_count || 0;
                        this.dashboardStats[2].value = this.alertCount;
                        this.dashboardStats[2].alert = this.alertCount;

                        // 渲染预警类型分布图
                        this.renderAlertTypeChart(data);
                    }

                    // 3. 获取供应商统计数据
                    await this.loadSupplierStatsForTrend();

                } catch (error) {
                    console.error('加载数据失败:', error);
                    ElMessage.error('加载数据失败');
                }
            },
            async loadSupplierStatsForTrend() {
                try {
                    const res = await axios.get('/api/statistics/supplierStats');
                    if (res.data.code === 200) {
                        // 使用供应商数据来展示趋势（作为示例）
                        this.renderTrendChart(res.data.data);
                    }
                } catch (error) {
                    console.error('加载供应商数据失败:', error);
                }
            },
            initCharts() {
                // 图表在数据加载时渲染，这里不需要初始化
            },
            renderTrendChart(supplierData) {
                if (this.trendChart) {
                    this.trendChart.dispose();
                }
                this.trendChart = echarts.init(document.getElementById('trendChart'));

                if (!supplierData || supplierData.length === 0) {
                    const option = {
                        title: {
                            text: '暂无数据',
                            left: 'center',
                            top: 'center'
                        }
                    };
                    this.trendChart.setOption(option);
                    return;
                }

                // 使用供应商物料数量作为趋势数据
                const suppliers = supplierData.slice(0, 8).map(s => s.supplier_name);
                const materialCounts = supplierData.slice(0, 8).map(s => s.material_count || 0);
                const totalValues = supplierData.slice(0, 8).map(s => parseFloat(s.total_value) || 0);

                const option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross',
                            crossStyle: {
                                color: '#999'
                            }
                        }
                    },
                    legend: {
                        data: ['物料数量', '库存总值(万)']
                    },
                    xAxis: {
                        type: 'category',
                        data: suppliers,
                        axisLabel: {
                            rotate: 45
                        }
                    },
                    yAxis: [
                        {
                            type: 'value',
                            name: '物料数量',
                            min: 0
                        },
                        {
                            type: 'value',
                            name: '库存总值(万)',
                            min: 0
                        }
                    ],
                    series: [
                        {
                            name: '物料数量',
                            type: 'bar',
                            data: materialCounts,
                            itemStyle: {
                                color: '#5470c6'
                            }
                        },
                        {
                            name: '库存总值(万)',
                            type: 'line',
                            yAxisIndex: 1,
                            data: totalValues.map(v => (v / 10000).toFixed(2)),
                            itemStyle: {
                                color: '#ee6666'
                            }
                        }
                    ]
                };
                this.trendChart.setOption(option);
            },
            renderStockStatusChart(overviewData) {
                if (this.stockStatusChart) {
                    this.stockStatusChart.dispose();
                }
                this.stockStatusChart = echarts.init(document.getElementById('stockStatusChart'));

                if (!overviewData) {
                    const option = {
                        title: {
                            text: '暂无数据',
                            left: 'center',
                            top: 'center'
                        }
                    };
                    this.stockStatusChart.setOption(option);
                    return;
                }

                const total = overviewData.total_materials || 0;
                const lowStock = overviewData.low_stock_count || 0;
                const highStock = overviewData.high_stock_count || 0;
                const normalStock = total - lowStock - highStock;

                const option = {
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c} ({d}%)'
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left'
                    },
                    series: [{
                        name: '库存状态',
                        type: 'pie',
                        radius: '70%',
                        data: [
                            { value: normalStock, name: '正常库存', itemStyle: { color: '#67c23a' } },
                            { value: lowStock, name: '低库存', itemStyle: { color: '#f56c6c' } },
                            { value: highStock, name: '高库存', itemStyle: { color: '#e6a23c' } }
                        ],
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }]
                };
                this.stockStatusChart.setOption(option);
            },
            renderAlertTypeChart(alertStats) {
                if (this.alertTypeChart) {
                    this.alertTypeChart.dispose();
                }
                this.alertTypeChart = echarts.init(document.getElementById('alertTypeChart'));

                if (!alertStats) {
                    const option = {
                        title: {
                            text: '暂无数据',
                            left: 'center',
                            top: 'center'
                        }
                    };
                    this.alertTypeChart.setOption(option);
                    return;
                }

                const lowStock = alertStats.low_stock_count || 0;
                const highStock = alertStats.high_stock_count || 0;
                const prediction = alertStats.prediction_count || 0;
                const total = lowStock + highStock + prediction;

                const option = {
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c} ({d}%)'
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left'
                    },
                    series: [{
                        name: '预警类型',
                        type: 'pie',
                        radius: '70%',
                        data: [
                            {
                                value: lowStock,
                                name: '低库存预警',
                                itemStyle: { color: '#f56c6c' }
                            },
                            {
                                value: highStock,
                                name: '高库存预警',
                                itemStyle: { color: '#e6a23c' }
                            },
                            {
                                value: prediction,
                                name: '预测缺货',
                                itemStyle: { color: '#409eff' }
                            }
                        ],
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }]
                };
                this.alertTypeChart.setOption(option);
            },
            formatNumber(value) {
                if (value === null || value === undefined) return '0';
                const num = parseFloat(value);
                if (isNaN(num)) return '0';

                if (num >= 100000000) {
                    return (num / 100000000).toFixed(2) + '亿';
                } else if (num >= 10000) {
                    return (num / 10000).toFixed(2) + '万';
                } else {
                    return num.toLocaleString('zh-CN', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                }
            }
        }
    }).use(ElementPlus).mount('#app');
</script>
</body>
</html>