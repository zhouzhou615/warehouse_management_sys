<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.warehouse_management_sys.Mapper.StatisticsMapper">

    <!-- 月度出入库统计（包含供应商信息） -->
    <select id="monthlyStatistics" resultType="org.example.warehouse_management_sys.DTO.StatisticsDTO">
        SELECT
            ir.material_id AS materialId,
            m.material_name AS materialName,
            s.supplier_name AS supplierName,
            TO_CHAR(ir.operation_time, 'YYYY-MM') AS yearMonth,
            SUM(CASE WHEN ir.inout_type = '入库' THEN ir.quantity ELSE 0 END) AS inQuantity,
            SUM(CASE WHEN ir.inout_type = '出库' THEN ir.quantity ELSE 0 END) AS outQuantity,
            SUM(CASE WHEN ir.inout_type = '入库' THEN ir.quantity ELSE -ir.quantity END) AS netChange,
            COUNT(*) AS recordCount,
            ROUND(AVG(ir.quantity), 2) AS avgQuantity
        FROM INOUT_RECORD ir
                 LEFT JOIN MATERIAL m ON ir.material_id = m.material_id
                 LEFT JOIN SUPPLIER s ON m.supplier_id = s.supplier_id
        WHERE TO_CHAR(ir.operation_time, 'YYYY') = #{year}::TEXT
          AND TO_CHAR(ir.operation_time, 'MM') = LPAD(#{month}::TEXT, 2, '0')
        GROUP BY ir.material_id, m.material_name, s.supplier_name, TO_CHAR(ir.operation_time, 'YYYY-MM')
        ORDER BY netChange DESC
    </select>

    <!-- 按类别统计流量 -->
    <select id="categoryFlowStatistics" resultType="org.example.warehouse_management_sys.DTO.StatisticsDTO">
        SELECT
            mc.category_name AS categoryName,
            TO_CHAR(ir.operation_time, 'YYYY-MM') AS yearMonth,
            SUM(CASE WHEN ir.inout_type = '入库' THEN ir.quantity ELSE 0 END) AS inQuantity,
            SUM(CASE WHEN ir.inout_type = '出库' THEN ir.quantity ELSE 0 END) AS outQuantity,
            COUNT(*) AS recordCount
        FROM INOUT_RECORD ir
                 JOIN MATERIAL m ON ir.material_id = m.material_id
                 JOIN MATERIAL_CATEGORY mc ON m.category_id = mc.category_id
        WHERE ir.operation_time BETWEEN #{startDate}::timestamp AND #{endDate}::timestamp
        GROUP BY mc.category_name, TO_CHAR(ir.operation_time, 'YYYY-MM')
        ORDER BY yearMonth, categoryName
    </select>

    <!-- 物料出入库趋势 -->
    <select id="materialTrend" resultType="map">
        SELECT
            TO_CHAR(ir.operation_time, 'YYYY-MM') AS month,
            SUM(CASE WHEN ir.inout_type = '入库' THEN ir.quantity ELSE 0 END) AS in_quantity,
            SUM(CASE WHEN ir.inout_type = '出库' THEN ir.quantity ELSE 0 END) AS out_quantity,
            MAX(ir.after_stock) AS end_stock
        FROM INOUT_RECORD ir
        WHERE ir.material_id = #{materialId}
          AND ir.operation_time >= CURRENT_DATE - INTERVAL '${months} months'
        GROUP BY TO_CHAR(ir.operation_time, 'YYYY-MM')
        ORDER BY month
    </select>

    <!-- 库存总览 -->
    <select id="stockOverview" resultType="map">
        SELECT
            COUNT(*) AS total_materials,
            SUM(current_stock * COALESCE(unit_price, 0)) AS total_value,
            SUM(CASE WHEN current_stock &lt; safe_stock_min THEN 1 ELSE 0 END) AS low_stock_count,
            SUM(CASE WHEN current_stock &gt; safe_stock_max THEN 1 ELSE 0 END) AS high_stock_count,
            (SELECT COUNT(*)
             FROM INOUT_RECORD
             WHERE DATE(operation_time) = CURRENT_DATE) AS today_inout
        FROM MATERIAL
        WHERE status = '正常'
    </select>

    <!-- 预警统计 -->
    <select id="alertStatistics" resultType="map">
        SELECT
            COUNT(*) AS total_alerts,
            SUM(CASE WHEN status = '未处理' THEN 1 ELSE 0 END) AS unhandled_count,
            SUM(CASE WHEN alert_type = '低库存' THEN 1 ELSE 0 END) AS low_stock_count,
            SUM(CASE WHEN alert_type = '高库存' THEN 1 ELSE 0 END) AS high_stock_count,
            SUM(CASE WHEN alert_type = '预测缺货' THEN 1 ELSE 0 END) AS prediction_count
        FROM STOCK_ALERT
    </select>

    <!-- 供应商物料统计 -->
    <select id="supplierMaterialStatistics" resultType="map">
        SELECT
            s.supplier_id,
            s.supplier_name,
            COUNT(m.material_id) AS material_count,
            SUM(m.current_stock * COALESCE(m.unit_price, 0)) AS total_value,
            SUM(CASE WHEN m.current_stock &lt; m.safe_stock_min THEN 1 ELSE 0 END) AS low_stock_count
        FROM SUPPLIER s
                 LEFT JOIN MATERIAL m ON s.supplier_id = m.supplier_id AND m.status = '正常'
        WHERE s.status = '合作中'
        GROUP BY s.supplier_id, s.supplier_name
        ORDER BY material_count DESC
    </select>
</mapper>