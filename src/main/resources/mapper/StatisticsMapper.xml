<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.warehouse_management_sys.Mapper.StatisticsMapper">

    <!-- 月度出入库统计 -->
    <select id="monthlyStatistics" resultType="org.example.warehouse_management_sys.DTO.StatisticsDTO">
        SELECT
            ir.material_id AS materialId,
            m.material_name AS materialName,
            s.supplier_name AS supplierName,
            TO_CHAR(ir.operation_time, 'YYYY-MM') AS yearMonth,
            COALESCE(SUM(CASE WHEN ir.inout_type = '入库' THEN ir.quantity ELSE 0 END), 0) AS inQuantity,
            COALESCE(SUM(CASE WHEN ir.inout_type = '出库' THEN ir.quantity ELSE 0 END), 0) AS outQuantity,
            COALESCE(SUM(CASE WHEN ir.inout_type = '入库' THEN ir.quantity ELSE -ir.quantity END), 0) AS netChange,
            COALESCE(COUNT(*), 0) AS recordCount,
            COALESCE(ROUND(AVG(ir.quantity), 2), 0) AS avgQuantity
        FROM inout_record ir
                 LEFT JOIN material m ON ir.material_id = m.material_id
                 LEFT JOIN supplier s ON m.supplier_id = s.supplier_id
        WHERE EXTRACT(YEAR FROM ir.operation_time) = #{year}
          AND EXTRACT(MONTH FROM ir.operation_time) = #{month}
          AND m.status = '正常'
        GROUP BY ir.material_id, m.material_name, s.supplier_name, TO_CHAR(ir.operation_time, 'YYYY-MM')
        ORDER BY netChange DESC
    </select>

    <!-- 按类别统计流量 -->
    <select id="categoryFlowStatistics" resultType="org.example.warehouse_management_sys.DTO.StatisticsDTO">
        SELECT
            mc.category_name AS categoryName,
            TO_CHAR(ir.operation_time, 'YYYY-MM') AS yearMonth,
            COALESCE(SUM(CASE WHEN ir.inout_type = '入库' THEN ir.quantity ELSE 0 END), 0) AS inQuantity,
            COALESCE(SUM(CASE WHEN ir.inout_type = '出库' THEN ir.quantity ELSE 0 END), 0) AS outQuantity,
            COALESCE(COUNT(*), 0) AS recordCount
        FROM inout_record ir
                 JOIN material m ON ir.material_id = m.material_id
                 JOIN material_category mc ON m.category_id = mc.category_id
        WHERE DATE_TRUNC('day', ir.operation_time) BETWEEN
            DATE_TRUNC('day', TO_TIMESTAMP(#{startDate}, 'YYYY-MM-DD')) AND
            DATE_TRUNC('day', TO_TIMESTAMP(#{endDate}, 'YYYY-MM-DD'))
          AND m.status = '正常'
        GROUP BY mc.category_name, TO_CHAR(ir.operation_time, 'YYYY-MM')
        ORDER BY yearMonth, categoryName
    </select>

    <!-- 物料出入库趋势 -->
    <select id="materialTrend" resultType="map">
        SELECT
            TO_CHAR(ir.operation_time, 'YYYY-MM') AS month,
            COALESCE(SUM(CASE WHEN ir.inout_type = '入库' THEN ir.quantity ELSE 0 END), 0) AS in_quantity,
            COALESCE(SUM(CASE WHEN ir.inout_type = '出库' THEN ir.quantity ELSE 0 END), 0) AS out_quantity,
            COALESCE(MAX(ir.after_stock), 0) AS end_stock
        FROM inout_record ir
        WHERE ir.material_id = #{materialId}
          AND DATE_TRUNC('day', ir.operation_time) >= DATE_TRUNC('day', CURRENT_TIMESTAMP - INTERVAL '${months} months')
        GROUP BY TO_CHAR(ir.operation_time, 'YYYY-MM')
        ORDER BY month
    </select>

    <!-- 库存总览 -->
    <select id="stockOverview" resultType="map">
        SELECT
            COALESCE(COUNT(*), 0) AS total_materials,
            COALESCE(SUM(m.current_stock * m.unit_price), 0) AS total_value,
            COALESCE(SUM(CASE WHEN m.current_stock &lt; m.safe_stock_min THEN 1 ELSE 0 END), 0) AS low_stock_count,
            COALESCE(SUM(CASE WHEN m.current_stock &gt; m.safe_stock_max THEN 1 ELSE 0 END), 0) AS high_stock_count,
            COALESCE((
                         SELECT COALESCE(SUM(quantity), 0)
                         FROM inout_record ir
                         WHERE DATE_TRUNC('day', ir.operation_time) = DATE_TRUNC('day', CURRENT_TIMESTAMP)
                     ), 0) AS today_inout
        FROM material m
        WHERE m.status = '正常'
    </select>

    <!-- 预警统计 -->
    <select id="alertStatistics" resultType="map">
        SELECT
            COALESCE(COUNT(*), 0) AS total_alerts,
            COALESCE(SUM(CASE WHEN status = '未处理' THEN 1 ELSE 0 END), 0) AS unhandled_count,
            COALESCE(SUM(CASE WHEN alert_type = '低库存' THEN 1 ELSE 0 END), 0) AS low_stock_count,
            COALESCE(SUM(CASE WHEN alert_type = '高库存' THEN 1 ELSE 0 END), 0) AS high_stock_count,
            COALESCE(SUM(CASE WHEN alert_type = '预测缺货' THEN 1 ELSE 0 END), 0) AS prediction_count
        FROM stock_alert
        WHERE DATE_TRUNC('day', create_time) >= DATE_TRUNC('day', CURRENT_TIMESTAMP - INTERVAL '7 days')
    </select>

    <!-- 供应商物料统计 -->
    <select id="supplierMaterialStatistics" resultType="map">
        SELECT
            s.supplier_id,
            s.supplier_name,
            COALESCE(COUNT(m.material_id), 0) AS material_count,
            COALESCE(SUM(m.current_stock * m.unit_price), 0) AS total_value,
            COALESCE(SUM(CASE WHEN m.current_stock &lt; m.safe_stock_min THEN 1 ELSE 0 END), 0) AS low_stock_count
        FROM supplier s
                 LEFT JOIN material m ON s.supplier_id = m.supplier_id AND m.status = '正常'
        WHERE s.status = '合作中'
        GROUP BY s.supplier_id, s.supplier_name
        ORDER BY material_count DESC
    </select>

    <!-- 今日出入库统计 -->
    <select id="getTodayInOutStatistics" resultType="map">
        SELECT
            COALESCE(SUM(CASE WHEN inout_type = '入库' THEN quantity ELSE 0 END), 0) AS today_in,
            COALESCE(SUM(CASE WHEN inout_type = '出库' THEN quantity ELSE 0 END), 0) AS today_out,
            COALESCE(COUNT(*), 0) AS today_count
        FROM inout_record
        WHERE DATE_TRUNC('day', operation_time) = DATE_TRUNC('day', CURRENT_TIMESTAMP)
    </select>
</mapper>